<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>aiuser â€“ all images by user</title>
    <script src="https://tools-static.wmflabs.org/cdnjs/ajax/libs/jquery/3.4.1/jquery.js"></script>
    <script src="https://tools-static.wmflabs.org/cdnjs/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.js"></script>
    <script src="https://tools-static.wmflabs.org/cdnjs/ajax/libs/datatables/1.10.19/js/jquery.dataTables.js"></script>
    <link
      rel="stylesheet"
      href="https://tools-static.wmflabs.org/cdnjs/ajax/libs/datatables/1.10.19/css/jquery.dataTables.css"
    />
  </head>
  <body>
    <div class="container">
      <table id="data">
        <thead>
          <tr>
            <th>File</th>
            <th>Upload date</th>
            <th>Original date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <script>
      const table = jQuery('#data').DataTable({
        paging: false,
        columns: [
          {
            data: null,
            render: (data, type, row, meta) =>
              `<a href="${data.descriptionurl}" target="_blank">${data.title}</a>`
          },
          {
            data: null,
            render: 'timestamp'
          },
          {
            data: null,
            render: (data, type, row, meta) =>
              data.DateTimeOriginal ? data.DateTimeOriginal.value : ''
          }
        ]
      });
      let user = getUserFromLocation();
      if (!user) {
        user = getUserViaPrompt();
      }
      if (user) {
        aiuser(user);
      }

      function getUserFromLocation() {
        if (!URLSearchParams) return;
        if (!location.search) return;
        const params = new URLSearchParams(location.search);
        return params.get('user');
      }

      function getUserViaPrompt() {
        return prompt('Specify Wikimedia username!');
      }

      function aiuser(user, options) {
        const url =
          'https://commons.wikimedia.org/w/api.php?' +
          $.param(
            $.extend(
              {
                action: 'query',
                format: 'json',
                origin: '*',
                list: 'allimages',
                aiuser: user,
                aisort: 'timestamp',
                aiprop: 'timestamp|url|metadata',
                ailimit: 500
              },
              options || {}
            )
          );
        return fetch(url)
          .then(response => response.json())
          .then(data => {
            // console.table(data.query.allimages);
            data.query.allimages.map(image => {
              image.DateTimeOriginal = image.metadata.find(m => m.name === 'DateTimeOriginal');
              table.row.add(image);
            });
            table.draw();
            if (data.continue) {
              return aiuser(user, data.continue);
            }
          });
      }
    </script>
  </body>
</html>
