<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>aiuser â€“ all images by user</title>
    <script src="https://tools-static.wmflabs.org/cdnjs/ajax/libs/jquery/3.4.1/jquery.js"></script>
    <script src="https://tools-static.wmflabs.org/cdnjs/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.js"></script>
    <script src="https://tools-static.wmflabs.org/cdnjs/ajax/libs/datatables/1.10.19/js/jquery.dataTables.js"></script>
    <link
      rel="stylesheet"
      href="https://tools-static.wmflabs.org/cdnjs/ajax/libs/datatables/1.10.19/css/jquery.dataTables.css"
    />
  </head>
  <body>
    <div class="container">
      <table id="data">
        <thead>
          <tr>
            <th>File</th>
            <th>Upload date</th>
            <th>Original date</th>
            <th>Artist</th>
            <th>License</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <script>
      const table = jQuery('#data').DataTable({
        paging: false,
        columns: [
          {
            data: null,
            render: (data, type, row, meta) =>
              `<a href="${data.imageinfo[0].descriptionurl}" target="_blank">${data.title}</a>`
          },
          {data: null, render: 'metadata.DateTime.value'},
          {data: null, render: 'metadata.DateTimeOriginal.value'},
          {data: null, render: 'metadata.Artist.value'},
          {data: null, render: 'metadata.LicenseShortName.value'}
        ]
      });
      let user = getUserFromLocation();
      if (!user) {
        user = getUserViaPrompt();
      }
      if (user) {
        aiuser(user, {}, 3);
      }

      function getUserFromLocation() {
        if (!URLSearchParams) return;
        if (!location.search) return;
        const params = new URLSearchParams(location.search);
        return params.get('user');
      }

      function getUserViaPrompt() {
        return prompt('Specify Wikimedia username!');
      }

      function aiuser(user, options, retry) {
        const url =
          'https://commons.wikimedia.org/w/api.php?' +
          $.param(
            $.extend(
              {
                action: 'query',
                format: 'json',
                origin: '*',
                generator: 'allimages',
                gaiuser: user,
                gaisort: 'timestamp',
                gaiprop: 'timestamp|url',
                gailimit: 200,
                prop: 'imageinfo',
                iiprop: 'url|extmetadata',
                iiextmetadatafilter: 'DateTime|DateTimeOriginal|Categories|Artist|LicenseShortName'
              },
              options || {}
            )
          );
        return fetch(url)
          .then(response => response.json())
          .then(data => {
            Object.values(data.query.pages).map(image => {
              image.metadata = image.imageinfo[0].extmetadata;
              table.row.add(image);
            });
            table.draw();
            if (data.continue) {
              return aiuser(user, data.continue, 3);
            }
          }).catch(err => {
            if (retry > 0) {
              return aiuser(user, options, retry - 1);
            } else {
              throw err;
            }
          });
      }
    </script>
  </body>
</html>
